#!/bin/bash

echo "ğŸ” Pre-commit hook ì‹¤í–‰ ì¤‘..."

# í¬ìŠ¤íŠ¸ íŒŒì¼(.md) ë³€ê²½ ê°ì§€
CHANGED_POSTS=$(git diff --cached --name-only | grep "^src/posts/.*\.md$")

if [ -n "$CHANGED_POSTS" ]; then
    echo "ğŸ“ í¬ìŠ¤íŠ¸ íŒŒì¼ ë³€ê²½ ê°ì§€:"
    echo "$CHANGED_POSTS"
    echo ""
    
    # í˜„ì¬ ë‚ ì§œ (YYYY-MM-DD í˜•ì‹)
    TODAY=$(date +%Y-%m-%d)
    
    # date í•„ë“œ ì—…ë°ì´íŠ¸
    echo "ğŸ“… í¬ìŠ¤íŠ¸ date í•„ë“œ ì—…ë°ì´íŠ¸ ì¤‘..."
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            # frontmatterì˜ date í•„ë“œë¥¼ í˜„ì¬ ë‚ ì§œë¡œ ì—…ë°ì´íŠ¸
            if [[ "$OSTYPE" == "darwin"* ]]; then
                # macOSìš©
                sed -i '' "s/^date: .*/date: $TODAY/" "$file"
            else
                # Linuxìš©
                sed -i "s/^date: .*/date: $TODAY/" "$file"
            fi
            git add "$file"
            echo "  âœï¸  $file"
        fi
    done <<< "$CHANGED_POSTS"
    echo ""
    
    echo "ğŸ”„ ê²€ìƒ‰ ë°ì´í„° ì—…ë°ì´íŠ¸ ì¤‘..."
    
    # Node.jsë¡œ ê²€ìƒ‰ ë°ì´í„° ìƒì„±
    if node src/lib/generate-search-data.js; then
        echo ""
        echo "âœ… ê²€ìƒ‰ ë°ì´í„° ìƒì„± ì™„ë£Œ"
        
        # search-data.jsonì„ staging areaì— ì¶”ê°€
        if [ -f "static/search-data.json" ]; then
            git add static/search-data.json
            echo "ğŸ“‹ search-data.jsonì„ ì»¤ë°‹ì— í¬í•¨"
        fi
    else
        echo ""
        echo "âŒ ê²€ìƒ‰ ë°ì´í„° ìƒì„± ì‹¤íŒ¨"
        exit 1
    fi
else
    echo "â„¹ï¸ í¬ìŠ¤íŠ¸ íŒŒì¼ ë³€ê²½ ì—†ìŒ"
fi

echo "âœ… Pre-commit hook ì™„ë£Œ"
exit 0
